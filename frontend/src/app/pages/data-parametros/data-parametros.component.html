<ion-header>
  <ion-toolbar>
    <ion-title>Pre√ßoLeite</ion-title>
    <ion-buttons slot="end">
      <ion-menu-button autoHide="false"></ion-menu-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- üîç Filtros -->
  <ion-card>
    <ion-card-content>

      <!-- Filtro de Munic√≠pio -->
      <ion-item>
        <ion-label position="stacked">
          <ion-icon name="location-outline" slot="start" class="ion-margin-end"></ion-icon>
          Filtro por Munic√≠pio
        </ion-label>
        <ion-select [(ngModel)]="municipioSelecionado" (ngModelChange)="atualizarFiltros()" placeholder="Selecione"
          interface="popover">
          <ion-select-option value="geral">Todos os Munic√≠pios</ion-select-option>
          @for (m of municipiosDisponiveis; track m) {
            <ion-select-option [value]="m">{{ m }}</ion-select-option>
          }
        </ion-select>
      </ion-item>

      <!-- Filtro de M√™s -->
      <ion-item class="ion-margin-top">
        <ion-label position="stacked">
          <ion-icon name="calendar-outline" slot="start" class="ion-margin-end"></ion-icon>
          Filtro por M√™s
        </ion-label>
        <ion-select [(ngModel)]="mesReferencia" (ngModelChange)="atualizarFiltros()" placeholder="Todos os Meses"
          interface="popover">
          <ion-select-option [value]="null">Todos os Meses</ion-select-option>
          @for (mes of mesesDisponiveis; track mes.valor) {
            <ion-select-option [value]="mes.valor">{{ mes.nome }}</ion-select-option>
          }
        </ion-select>
      </ion-item>

      <!-- Filtro de Ano -->
      <ion-item class="ion-margin-top">
        <ion-label position="stacked">
          <ion-icon name="calendar-number-outline" slot="start" class="ion-margin-end"></ion-icon>
          Filtro por Ano
        </ion-label>
        <ion-select [(ngModel)]="anoSelecionado" (ngModelChange)="atualizarFiltros()" placeholder="Ano"
          interface="popover">
          @for (ano of anosDisponiveis; track ano) {
            <ion-select-option [value]="ano">{{ ano }}</ion-select-option>
          }
        </ion-select>
      </ion-item>

      <!-- Faixa de Litros -->
      @if (agrupamentoSelecionado === 'laticinio') {
        <ion-item class="ion-margin-top faixa-item">
          <ion-label style="margin-bottom: 10px;" position="stacked">
            <ion-icon name="stats-chart-outline" slot="start" class="ion-margin-end"></ion-icon>
            Faixa de Litros
          </ion-label>
          <div class="faixa-container">
            <ion-input type="number" placeholder="M√≠nimo" [(ngModel)]="faixaMin" (ngModelChange)="atualizarFiltros()"
              class="faixa-input"
              [class.invalido]="faixaMin !== null && faixaMax !== null && faixaMin >= faixaMax"></ion-input>
            <span class="faixa-separador">‚Äî</span>
            <ion-input type="number" placeholder="M√°ximo" [(ngModel)]="faixaMax" (ngModelChange)="atualizarFiltros()"
              class="faixa-input"
              [class.invalido]="faixaMin !== null && faixaMax !== null && faixaMin >= faixaMax"></ion-input>
          </div>
        </ion-item>
      }

      <!-- Bot√£o limpar -->
      @if (municipioSelecionado !== 'geral' || mesReferencia !== null || anoSelecionado !== currentYear || faixaMin !== null || faixaMax !== null) {
        <div class="ion-margin-top">
          <ion-button expand="block" (click)="limparFiltros()">Limpar Filtros</ion-button>
        </div>
      }

      <!-- Segmento de agrupamento -->
      @if (municipioSelecionado) {
        <ion-segment [(ngModel)]="agrupamentoSelecionado" class="ion-margin-top">
          <ion-segment-button value="laticinio">
            <ion-label>Latic√≠nio</ion-label>
          </ion-segment-button>
          <ion-segment-button value="mes">
            <ion-label>M√™s</ion-label>
          </ion-segment-button>
          <ion-segment-button value="regiao">
            <ion-label>Regi√£o</ion-label>
          </ion-segment-button>
        </ion-segment>
      }
    </ion-card-content>
  </ion-card>

  <!-- ========================= POR REGI√ÉO ========================= -->
  @if (agrupamentoSelecionado === 'regiao') {
    <ion-text color="medium">
      <h2 style="margin: 16px 16px 8px; font-weight: 600; font-size: 16px;">M√©dia de Pre√ßo por Regi√£o</h2>
      @if (tituloGraficoFiltrado) {
        <h3 [innerHTML]="tituloGraficoFiltrado" style="
          margin: 0 16px 16px;
          font-weight: 500;
          font-size: 1.1rem;
          color: #4b5563;
          letter-spacing: 0.5px;
          line-height: 1.4;
          border-left: 4px solid rgba(0,255,128,0.2);
          padding-left: 12px;">
        </h3>
      }
    </ion-text>

    @if (municipioSelecionado && municipioSelecionado.toLowerCase() !== 'geral') {
      @for (grupo of dadosPorRegiao; track trackByLaticinio($index, grupo)) {
        <ion-card>
          <ion-card-header>
            <ion-card-title>{{ grupo.regiao }}</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            @for (lat of grupo.laticinios; track trackByFaixa($index, lat)) {
              <ion-item>
                <ion-label style="display: flex; align-items: center; gap: 6px;">
                  <img [src]="laticinioIcons[lat.laticinio] || 'assets/icon/default.svg'" alt="{{ lat.laticinio }} icon"
                    style="width: 20px; height: 20px;" />
                  {{ lat.laticinio }}
                </ion-label>
                <ion-note slot="end">R$ {{ lat.mediaPreco | number:'1.2-2' }}</ion-note>
              </ion-item>
            }
          </ion-card-content>
        </ion-card>
      }

      <!-- Gr√°fico -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            Gr√°fico por Regi√£o
            @if (mesReferencia) {
              ({{ obterNomeMes(mesReferencia) }})
            }
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <canvas #graficoRegiao style="width: 100%; max-width: 600px; height: 300px;"></canvas>
        </ion-card-content>
      </ion-card>
    } @else {
      <ion-card>
        <ion-card-header>
          <ion-card-title>Selecione a regi√£o</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          Nenhum dado dispon√≠vel at√© que uma regi√£o seja selecionada.
        </ion-card-content>
      </ion-card>
    }
  }

  <!-- ========================= POR LATIC√çNIO ========================= -->
  @if (agrupamentoSelecionado === 'laticinio') {
    @if (temDadosFaixas()) {
      <ion-text color="medium">
        <h2 style="margin: 16px 16px 8px; font-weight: 600; font-size: 16px;">M√©dia de Pre√ßo por Faixas</h2>
        @if (tituloGraficoFiltrado) {
          <h3 [innerHTML]="tituloGraficoFiltrado" style="
            margin: 0 16px 16px;
            font-weight: 500;
            font-size: 1.1rem;
            color: #4b5563;
            letter-spacing: 0.5px;
            line-height: 1.4;
            border-left: 4px solid rgba(0,255,128,0.2);
            padding-left: 12px;">
          </h3>
        }
      </ion-text>

      @for (grupo of dadosPorLaticinioFaixas; track trackByLaticinio($index, grupo)) {
        <ion-card>
          <ion-card-header>
            <ion-card-title>
              Latic√≠nio:
              <img [src]="laticinioIcons[grupo.laticinio]" alt="{{ grupo.laticinio }} icon" class="laticinio-icon"
                style="width:20px; height:20px; margin-left:6px;" />
              {{ grupo.laticinio }}
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            @for (faixa of (grupo.faixas | faixaValida); track trackByFaixa($index, faixa)) {
              <ion-item>
                <ion-label>
                  Litros: {{ faixa.faixa }} ‚Äî M√©dia Pre√ßo: R$ {{ faixa.mediaPreco | number:'1.2-2' }}
                </ion-label>
              </ion-item>
            }
          </ion-card-content>
        </ion-card>
      }

      <!-- Gr√°fico -->
      <ion-card>
        <ion-card-header>
          <ion-icon name="bar-chart-outline" color="primary"></ion-icon>
        </ion-card-header>
        <ion-card-content>
          <canvas id="graficoLitrosPreco" style="width: 100%; max-width: 600px; height: 300px;"></canvas>
        </ion-card-content>
      </ion-card>
    } @else {
      <ion-card color="light">
        <ion-card-content>
          <ion-text color="medium">
            Nenhum dado dispon√≠vel para o munic√≠pio ou intervalo selecionado.
          </ion-text>
        </ion-card-content>
      </ion-card>
    }
  }

  <!-- ========================= POR M√äS ========================= -->
@if (agrupamentoSelecionado === 'mes') {
  @if (dadosPorMes.length > 0) {
    <ion-text color="medium">
      <h2 style="margin: 16px 16px 8px; font-weight: 600; font-size: 16px;">
        M√©dia de Pre√ßo por M√™s
      </h2>
      @if (tituloGraficoFiltrado) {
        <h3 [innerHTML]="tituloGraficoFiltrado" style="
          margin: 0 16px 16px;
          font-weight: 500;
          font-size: 1.1rem;
          color: #4b5563;
          letter-spacing: 0.5px;
          line-height: 1.4;
          border-left: 4px solid rgba(0,255,128,0.2);
          padding-left: 12px;">
        </h3>
      }
    </ion-text>

    @for (grupo of dadosPorMes; track trackByLaticinio($index, grupo)) {
      <ion-card>
        <ion-card-header>
          <ion-card-title>{{ grupo.mes }}</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          @for (item of grupo.items; track trackByFaixa($index, item)) {
            <ion-item>
              <ion-label style="display: flex; align-items: center; gap: 6px;">
                <img
                  [src]="laticinioIcons[item.laticinio] || 'assets/icon/default.svg'"
                  alt="{{ item.laticinio }} icon"
                  style="width: 20px; height: 20px;"
                />
                <div>
                  {{ item.laticinio }}<br />
                  M√©dia Geral: R$ {{ item.mediaPrecoDoLaticinio | number:'1.2-2' }}
                </div>
              </ion-label>
            </ion-item>
          }
        </ion-card-content>
      </ion-card>
    }
  } @else {
    <ion-card color="light">
      <ion-card-content>
        <ion-text color="medium">
          Nenhum dado dispon√≠vel para os filtros aplicados.
        </ion-text>
      </ion-card-content>
    </ion-card>
  }
}
</ion-content>
